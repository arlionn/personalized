<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Fitting subgroup identification models — fit.subgroup • personalized</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Fitting subgroup identification models — fit.subgroup" />
<meta property="og:description" content="Fits subgroup identification model class of Chen, et al (2017)" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">personalized</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/usage_of_the_personalized_package.html">Usage of the personalized Package</a>
    </li>
    <li>
      <a href="../articles/efficiency_augmentation_personalized.html">Improving Estimation Efficiency via Augmentation and Propensity Score Utilities</a>
    </li>
    <li>
      <a href="../articles/multicategory_treatments_with_personalized.html">Multi-category Treatments with personalized</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/jaredhuling/personalized">
    <span class="fas fa-github"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Fitting subgroup identification models</h1>
    <small class="dont-index">Source: <a href='https://github.com/jaredhuling/personalized/blob/master/R/fit_subgroup.R'><code>R/fit_subgroup.R</code></a></small>
    <div class="hidden name"><code>fit.subgroup.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Fits subgroup identification model class of Chen, et al (2017)</p>
    </div>

    <pre class="usage"><span class='fu'>fit.subgroup</span><span class='op'>(</span>
  <span class='va'>x</span>,
  <span class='va'>y</span>,
  <span class='va'>trt</span>,
  propensity.func <span class='op'>=</span> <span class='cn'>NULL</span>,
  loss <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"sq_loss_lasso"</span>, <span class='st'>"logistic_loss_lasso"</span>, <span class='st'>"poisson_loss_lasso"</span>,
    <span class='st'>"cox_loss_lasso"</span>, <span class='st'>"owl_logistic_loss_lasso"</span>, <span class='st'>"owl_logistic_flip_loss_lasso"</span>,
    <span class='st'>"owl_hinge_loss"</span>, <span class='st'>"owl_hinge_flip_loss"</span>, <span class='st'>"sq_loss_lasso_gam"</span>,
    <span class='st'>"poisson_loss_lasso_gam"</span>, <span class='st'>"logistic_loss_lasso_gam"</span>, <span class='st'>"sq_loss_gam"</span>,
    <span class='st'>"poisson_loss_gam"</span>, <span class='st'>"logistic_loss_gam"</span>, <span class='st'>"owl_logistic_loss_gam"</span>,
    <span class='st'>"owl_logistic_flip_loss_gam"</span>, <span class='st'>"owl_logistic_loss_lasso_gam"</span>,
    <span class='st'>"owl_logistic_flip_loss_lasso_gam"</span>, <span class='st'>"sq_loss_gbm"</span>, <span class='st'>"poisson_loss_gbm"</span>,
    <span class='st'>"logistic_loss_gbm"</span>, <span class='st'>"cox_loss_gbm"</span>,      <span class='st'>"custom"</span><span class='op'>)</span>,
  method <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"weighting"</span>, <span class='st'>"a_learning"</span><span class='op'>)</span>,
  match.id <span class='op'>=</span> <span class='cn'>NULL</span>,
  augment.func <span class='op'>=</span> <span class='cn'>NULL</span>,
  fit.custom.loss <span class='op'>=</span> <span class='cn'>NULL</span>,
  cutpoint <span class='op'>=</span> <span class='fl'>0</span>,
  larger.outcome.better <span class='op'>=</span> <span class='cn'>TRUE</span>,
  reference.trt <span class='op'>=</span> <span class='cn'>NULL</span>,
  retcall <span class='op'>=</span> <span class='cn'>TRUE</span>,
  <span class='va'>...</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>x</th>
      <td><p>The design matrix (not including intercept term)</p></td>
    </tr>
    <tr>
      <th>y</th>
      <td><p>The response vector</p></td>
    </tr>
    <tr>
      <th>trt</th>
      <td><p>treatment vector with each element equal to a 0 or a 1, with 1 indicating
treatment status is active.</p></td>
    </tr>
    <tr>
      <th>propensity.func</th>
      <td><p>function that inputs the design matrix x and the treatment vector trt and outputs
the propensity score, ie Pr(trt = 1 | X = x). Function should take two arguments 1) x and 2) trt. See example below.
For a randomized controlled trial this can simply be a function that returns a constant equal to the proportion
of patients assigned to the treatment group, i.e.:
<code>propensity.func = function(x, trt) 0.5</code>.</p></td>
    </tr>
    <tr>
      <th>loss</th>
      <td><p>choice of both the M function from Chen, et al (2017) and potentially the penalty used for variable selection.
All <code>loss</code> options starting with <code>sq_loss</code> use M(y, v) = (v - y) ^ 2, all options starting with <code>logistic_loss</code> use
the logistic loss: M(y, v) = y * log(1 + exp{-v}), and all options starting with <code>cox_loss</code> use the negative partial likelihood loss for the Cox PH model.
All options ending with <code>lasso</code> have a lasso penalty added to the loss for variable selection. <code>sq_loss_lasso_gam</code>
and <code>logistic_loss_lasso_gam</code> first use the lasso to select variables and then fit a generalized additive model
with nonparametric additive terms for each selected variable. <code>sq_loss_gam</code> involves a squared error loss with a generalized additive model and no variable selection.
<code>sq_loss_gbm</code> involves a squared error loss with a gradient-boosted decision trees model for the benefit score; this
allows for flexible estimation using machine learning and can be useful when the underlying treatment-covariate interaction
is complex.</p><ul>
<li><p><strong>Continuous Outcomes</strong></p><ul>
<li><p><code>"sq_loss_lasso"</code> - M(y, v) = (v - y) ^ 2 with linear model and lasso penalty</p></li>
<li><p><code>"owl_logistic_loss_lasso"</code>  - M(y, v) = ylog(1 + exp{-v}) (method of Regularized Outcome Weighted Subgroup Identification)</p></li>
<li><p><code>"owl_logistic_flip_loss_lasso"</code>  - M(y, v) = |y|log(1 + exp{-sign(y)v})</p></li>
<li><p><code>"owl_hinge_loss"</code>  - M(y, v) = ymax(0, 1 - v) (method of Estimating individualized treatment rules using outcome weighted learning)</p></li>
<li><p><code>"owl_hinge_flip_loss"</code>  - M(y, v) = |y|max(0, 1 - sign(y)v)</p></li>
<li><p><code>"sq_loss_lasso_gam"</code> - M(y, v) = (v - y) ^ 2 with variables selected by lasso penalty and generalized additive model fit on the selected variables</p></li>
<li><p><code>"sq_loss_gam"</code> - M(y, v) = (v - y) ^ 2 with generalized additive model fit on all variables</p></li>
<li><p><code>"owl_logistic_loss_gam"</code>  - M(y, v) = ylog(1 + exp{-v}) with generalized additive model fit on all variables</p></li>
<li><p><code>"owl_logistic_flip_loss_gam"</code>  - M(y, v) = |y|log(1 + exp{-sign(y)v}) with generalized additive model fit on all variables</p></li>
<li><p><code>"owl_logistic_loss_lasso_gam"</code>  - M(y, v) = ylog(1 + exp{-v}) with variables selected by lasso penalty and generalized additive model fit on the selected variables</p></li>
<li><p><code>"owl_logistic_flip_loss_lasso_gam"</code>  - M(y, v) = |y|log(1 + exp{-sign(y)v}) with variables selected by lasso penalty and generalized additive model fit on the selected variables</p></li>
<li><p><code>"sq_loss_gbm"</code> - M(y, v) = (v - y) ^ 2 with gradient-boosted decision trees model</p></li>
</ul></li>
<li><p><strong>Binary Outcomes</strong></p><ul>
<li><p>All losses for continuous outcomes can be used plus the following:</p></li>
<li><p><code>"logistic_loss_lasso"</code> - M(y, v) = -[yv - log(1 + exp{-v})] with with linear model and lasso penalty</p></li>
<li><p><code>"logistic_loss_lasso_gam"</code> - M(y, v) = -[yv - log(1 + exp{-v})] with variables selected by lasso penalty and generalized additive model fit on the selected variables</p></li>
<li><p><code>"logistic_loss_gam"</code> - M(y, v) = -[yv - log(1 + exp{-v})] with generalized additive model fit on all variables</p></li>
<li><p><code>"logistic_loss_gbm"</code> - M(y, v) = -[yv - log(1 + exp{-v})] with gradient-boosted decision trees model</p></li>
</ul></li>
<li><p><strong>Count Outcomes</strong></p><ul>
<li><p>All losses for continuous outcomes can be used plus the following:</p></li>
<li><p><code>"poisson_loss_lasso"</code> - M(y, v) = -[yv - exp(v)] with with linear model and lasso penalty</p></li>
<li><p><code>"poisson_loss_lasso_gam"</code> - M(y, v) = -[yv - exp(v)] with variables selected by lasso penalty and generalized additive model fit on the selected variables</p></li>
<li><p><code>"poisson_loss_gam"</code> - M(y, v) = -[yv - exp(v)] with generalized additive model fit on all variables</p></li>
<li><p><code>"poisson_loss_gbm"</code> - M(y, v) = -[yv - exp(v)] with gradient-boosted decision trees model</p></li>
</ul></li>
<li><p><strong>Time-to-Event Outcomes</strong></p><ul>
<li><p><code>"cox_loss_lasso"</code> - M corresponds to the negative partial likelihood of the cox model with linear model and additionally a lasso penalty</p></li>
<li><p><code>"cox_loss_gbm"</code> - M corresponds to the negative partial likelihood of the cox model with gradient-boosted decision trees model</p></li>
</ul></li>
</ul></td>
    </tr>
    <tr>
      <th>method</th>
      <td><p>subgroup ID model type. Either the weighting or A-learning method of Chen et al, (2017)</p></td>
    </tr>
    <tr>
      <th>match.id</th>
      <td><p>a (character, factor, or integer) vector with length equal to the number of observations in <code>x</code> indicating using integers or
levels of a factor vector which patients are
in which matched groups. Defaults to <code>NULL</code> and assumes the samples are not from a matched cohort. Matched
case-control groups can be created using any method (propensity score matching, optimal matching, etc). If each case
is matched with a control or multiple controls, this would indicate which case-control pairs or groups go together.
If <code>match.id</code> is supplied, then it is unecessary to specify a function via the <code>propensity.func</code> argument.
A quick usage example: if the first patient is a case and the second and third are controls matched to it, and the
fouth patient is a case and the fifth through seventh patients are matched with it, then the user should specify
<code>match.id = c(1,1,1,2,2,2,2)</code> or <code>match.id = c(rep("Grp1", 3),rep("Grp2", 4)) </code></p></td>
    </tr>
    <tr>
      <th>augment.func</th>
      <td><p>function which inputs the response <code>y</code>, the covariates <code>x</code>, and <code>trt</code> and outputs
predicted values (on the link scale) for the response using a model constructed with <code>x</code>. <code>augment.func()</code> can also be simply
a function of <code>x</code> and <code>y</code>. This function is used for efficiency augmentation.
When the form of the augmentation function is correct, it can provide efficient estimation of the subgroups. Some examples of possible
augmentation functions are:</p>
<p>Example 1: <code>augment.func &lt;- function(x, y) {lmod &lt;- lm(y ~ x); return(fitted(lmod))}</code></p>
<p>Example 2:</p><pre>
<span class='va'>augment.func</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span>, <span class='va'>trt</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>data</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span>, <span class='va'>trt</span><span class='op'>)</span>
    <span class='va'>lmod</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>y</span> <span class='op'>~</span> <span class='va'>x</span> <span class='op'>*</span> <span class='va'>trt</span><span class='op'>)</span>
    <span class='co'>## get predictions when trt = 1</span>
    <span class='va'>data</span><span class='op'>$</span><span class='va'>trt</span> <span class='op'>&lt;-</span> <span class='fl'>1</span>
    <span class='va'>preds_1</span>  <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>lmod</span>, <span class='va'>data</span><span class='op'>)</span>

    <span class='co'>## get predictions when trt = -1</span>
    <span class='va'>data</span><span class='op'>$</span><span class='va'>trt</span> <span class='op'>&lt;-</span> <span class='op'>-</span><span class='fl'>1</span>
    <span class='va'>preds_n1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>lmod</span>, <span class='va'>data</span><span class='op'>)</span>

    <span class='co'>## return predictions averaged over trt</span>
    <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='fl'>0.5</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>preds_1</span> <span class='op'>+</span> <span class='va'>preds_n1</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>
</pre>

<p>For binary and time-to-event outcomes, make sure that predictions are returned on the scale of the predictors</p>
<p>Example 3:</p><pre><span class='va'>augment.func</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span><span class='op'>)</span> <span class='op'>{</span>
        <span class='va'>bmod</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/glm.html'>glm</a></span><span class='op'>(</span><span class='va'>y</span> <span class='op'>~</span> <span class='va'>x</span>, family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>binomial</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
        <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>bmod</span>, type <span class='op'>=</span> <span class='st'>"link"</span><span class='op'>)</span><span class='op'>)</span>
    <span class='op'>}</span>
 </pre></td>
    </tr>
    <tr>
      <th>fit.custom.loss</th>
      <td><p>A function which <em>minimizes</em> a user-specified
custom loss function M(y,v) to be used in model fitting.
If provided, <code>fit.custom.loss</code> should take the modified
design matrix (which includes an intercept term)
as an argument and the responses and optimize a
custom weighted loss function.</p>
<p>The loss function \(M(y, v)\) to be minimized <strong>MUST</strong> meet
the following two criteria:</p><ol>
<li><p>\(D_M(y, v) = \partial M(y, v)/\partial v \) must be increasing in v for each fixed y. \(D_M(y, v)\) is the partial
derivative of the loss function M(y, v) with respect to v</p></li>
<li><p>\(D_M(y, 0)\) is monotone in y</p></li>
</ol><p>An example of a valid loss function is \(M(y, v) = (y - v)^2\). In this case \(D_M(y, v) = -2(y - v)\).
See Chen et al. (2017) for more details on the
restrictions on the loss function \(M(y, v)\).</p>
<p>The provided function <strong>MUST</strong> return a list with the following elements:</p><ul>
<li><p><code>predict</code> a function that inputs a design matrix and a 'type' argument for the type of predictions and outputs
a vector of predictions on the scale of the linear predictor. Note that the matrix provided to 'fit.custom.loss'
has a column appended to the first column of <code>x</code> corresponding to the treatment main effect.
Thus, the prediction function should deal with this,
e.g. <code><a href='https://rdrr.io/r/stats/predict.html'>predict(model, cbind(1, x))</a></code></p></li>
<li><p><code>model</code>  a fitted model object returned by the underlying fitting function</p></li>
<li><p><code>coefficients</code> if the underlying fitting function yields a vector of coefficient estimates, they should be provided here</p></li>
</ul>

<p>The provided function <strong>MUST</strong> be a function
with the following arguments:</p><ol>
<li><p><code>x</code> design matrix</p></li>
<li><p><code>y</code> vector of responses</p></li>
<li><p><code>weights</code> vector for observations weights. The underlying loss function <strong>MUST</strong> have samples weighted according
to this vector. See below example</p></li>
<li><p><code>...</code> additional arguments passed via '<code>...</code>'. This can be used so that users can specify more arguments to the
underlying fitting function if so desired.</p></li>
</ol><p>The provided function can also optionally take the following arguments:</p><ul>
<li><p><code>match.id</code> vector of case/control cluster IDs. This is useful if cross validation is used in the underlying fitting function
in which case it is advisable to sample whole clusters randomly instead of individual observations.</p></li>
<li><p><code>offset</code> if efficiency augmentation is used, the predictions from the outcome model from <code>augment.func</code>
will be provided via the <code>offset</code> argument, which can be used as an offset in the underlying fitting function
as a means of incorporating the efficiency augmentation model's predictions</p></li>
<li><p><code>trt</code> vector of treatment statuses</p></li>
<li><p><code>family</code> family of outcome</p></li>
<li><p><code>n.trts</code> numer of treatment levels. Can be useful if there are more than 2 treatment levels</p></li>
</ul>

<p>Example 1: Here we minimize \(M(y, v) = (y - v)^2\)</p><pre>
 <span class='va'>fit.custom.loss</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span>, <span class='va'>weights</span>, <span class='va'>...</span><span class='op'>)</span> <span class='op'>{</span>
     <span class='va'>df</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>y</span>, <span class='va'>x</span><span class='op'>)</span>

     <span class='co'># minimize squared error loss with NO lasso penalty</span>
     <span class='va'>lmf</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>y</span> <span class='op'>~</span> <span class='va'>x</span> <span class='op'>-</span> <span class='fl'>1</span>, weights <span class='op'>=</span> <span class='va'>weights</span>,
               data <span class='op'>=</span> <span class='va'>df</span>, <span class='va'>...</span><span class='op'>)</span>

     <span class='co'># save coefficients</span>
     <span class='va'>cfs</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/coef.html'>coef</a></span><span class='op'>(</span><span class='va'>lmf</span><span class='op'>)</span>

     <span class='co'># create prediction function. Notice</span>
     <span class='co'># how a column of 1's is appended</span>
     <span class='co'># to ensure treatment main effects are included</span>
     <span class='co'># in predictions</span>
     <span class='va'>prd</span> <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>type</span> <span class='op'>=</span> <span class='st'>"response"</span><span class='op'>)</span>
     <span class='op'>{</span>
         <span class='va'>dfte</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>x</span><span class='op'>)</span>
         <span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span><span class='op'>(</span><span class='va'>dfte</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>cfs</span><span class='op'>)</span>
         <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>lmf</span>, <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span><span class='va'>dfte</span><span class='op'>)</span><span class='op'>)</span>
     <span class='op'>}</span>
     <span class='co'># return lost of required components</span>
     <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>predict <span class='op'>=</span> <span class='va'>prd</span>, model <span class='op'>=</span> <span class='va'>lmf</span>, coefficients <span class='op'>=</span> <span class='va'>cfs</span><span class='op'>)</span>
 <span class='op'>}</span>
 </pre>

<p>Example 2: \(M(y, v) = y\exp(-v)\)</p><pre>
 fit.expo.loss &lt;- function(x, y, weights, ...)
 {
     ## define loss function to be minimized
     expo.loss &lt;- function(beta, x, y, weights) {
         sum(weights * y * exp(-drop(tcrossprod(x, t(beta) )))
     }

     # use optim() to minimize loss function
     opt &lt;- optim(rep(0, NCOL(x)), fn = expo.loss, x = x, y = y, weights = weights)

     coefs &lt;- opt$par

     pred &lt;- function(x, type = "response") {
         tcrossprod(cbind(1, x), t(coefs))
     }

     # return list of required components
     list(predict = pred, model = opt, coefficients = coefs)
 }
 </pre></td>
    </tr>
    <tr>
      <th>cutpoint</th>
      <td><p>numeric value for patients with benefit scores above which
(or below which if <code>larger.outcome.better = FALSE</code>)
will be recommended to be in the treatment group. Can also set <code>cutpoint = "median"</code>, which will
use the median value of the benefit scores as the cutpoint or can set specific quantile values via <code>"quantx"</code>
where <code>"x"</code> is a number between 0 and 100 representing the quantile value; e.g. <code>cutpoint = "quant75"</code>
will use the 75th perent upper quantile of the benefit scores as the quantile.</p></td>
    </tr>
    <tr>
      <th>larger.outcome.better</th>
      <td><p>boolean value of whether a larger outcome is better/preferable. Set to <code>TRUE</code>
if a larger outcome is better/preferable and set to <code>FALSE</code> if a smaller outcome is better/preferable. Defaults to <code>TRUE</code>.</p></td>
    </tr>
    <tr>
      <th>reference.trt</th>
      <td><p>which treatment should be treated as the reference treatment. Defaults to the first level of <code>trt</code>
if <code>trt</code> is a factor or the first alphabetical or numerically first treatment level. Not used for multiple treatment fitting with OWL-type losses.</p></td>
    </tr>
    <tr>
      <th>retcall</th>
      <td><p>boolean value. if <code>TRUE</code> then the passed arguments will be saved. Do not set to <code>FALSE</code>
if the <code><a href='validate.subgroup.html'>validate.subgroup()</a></code> function will later be used for your fitted subgroup model. Only set to <code>FALSE</code>
if memory is limited as setting to <code>TRUE</code> saves the design matrix to the fitted object</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>options to be passed to underlying fitting function. For all <code>loss</code> options with 'lasso',
this will be passed to <code><a href='https://glmnet.stanford.edu/reference/cv.glmnet.html'>cv.glmnet</a></code>. For all <code>loss</code> options with 'gam', this will
be passed to <code><a href='https://rdrr.io/pkg/mgcv/man/gam.html'>gam</a></code> from the <span class="pkg">mgcv</span> package
Note that for all <code>loss</code> options that use <code>gam()</code>
from the <span class="pkg">mgcv</span> package,
the user cannot supply the <code>gam</code> argument <code>method</code> because it is also an argument of <code>fit.subgroup</code>, so
instead, to change the <code>gam method</code> argument, supply <code>method.gam</code>, ie <code>method.gam = "REML"</code>.</p>
<p>For all <code>loss</code> options with 'hinge', this will be passed to both <code><a href='weighted.ksvm.html'>weighted.ksvm</a></code> and
<code><a href='https://rdrr.io/pkg/kernlab/man/ipop.html'>ipop</a></code> from the <span class="pkg">kernlab</span> package</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>An object of class <code>"subgroup_fitted"</code>.</p>
<dt>predict</dt><dd><p>A function that returns predictions of the covariate-conditional treatment effects</p></dd>
<dt>model</dt><dd><p>An object returned by the underlying fitting function used. For example, if the lasso use used to fit
the underlying subgroup identification model, this will be an object returned by <code>cv.glmnet</code>.</p></dd>
<dt>coefficients</dt><dd><p>If the underlying subgroup identification model is parametric, <code>coefficients</code> will contain
the estimated coefficients of the model.</p></dd>
<dt>call</dt><dd><p>The call that produced the returned object. If <code>retcall = TRUE</code>, this will contain all objects
supplied to <code>fit.subgroup()</code></p></dd>
<dt>family</dt><dd><p>The family corresponding to the outcome provided</p></dd>
<dt>loss</dt><dd><p>The loss function used</p></dd>
<dt>method</dt><dd><p>The method used (either weighting or A-learning)</p></dd>
<dt>propensity.func</dt><dd><p>The propensity score function used</p></dd>
<dt>larger.outcome.better</dt><dd><p>If larger outcomes are preferred for this model</p></dd>
<dt>cutpoint</dt><dd><p>Benefit score cutoff value used for determining subgroups</p></dd>
<dt>var.names</dt><dd><p>The names of all variables used</p></dd>
<dt>n.trts</dt><dd><p>The number of treatment levels</p></dd>
<dt>comparison.trts</dt><dd><p>All treatment levels other than the reference level</p></dd>
<dt>reference.trt</dt><dd><p>The reference level for the treatment. This should usually be the control group/level</p></dd>
<dt>trts</dt><dd><p>All treatment levels</p></dd>
<dt>trt.received</dt><dd><p>The vector of treatment assignments</p></dd>
<dt>pi.x</dt><dd><p>A vector of propensity scores</p></dd>
<dt>y</dt><dd><p>A vector of outcomes</p></dd>
<dt>benefit.scores</dt><dd><p>A vector of conditional treatment effects, i.e. benefit scores</p></dd>
<dt>recommended.trts</dt><dd><p>A vector of treatment recommendations (i.e. for each patient,
which treatment results in the best expected potential outcomes)</p></dd>
<dt>subgroup.trt.effects</dt><dd><p>(Biased) estimates of the conditional treatment effects
and conditional outcomes. These are essentially just empirical averages within
different combinations of treatment assignments and treatment recommendations</p></dd>
<dt>individual.trt.effects</dt><dd><p>estimates of the individual treatment effects as returned by
<code><a href='treatment.effects.html'>treat.effects</a></code></p></dd>

    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Huling. J.D. and Yu, M. (2021), Subgroup Identification Using the personalized Package.
Journal of Statistical Software 98(5), 1-60. doi:10.18637/jss.v098.i05</p>
<p>Chen, S., Tian, L., Cai, T. and Yu, M. (2017), A general statistical framework for subgroup identification
and comparative treatment scoring. Biometrics. doi:10.1111/biom.12676 <a href='https://onlinelibrary.wiley.com/doi/abs/10.1111/biom.12676'>https://onlinelibrary.wiley.com/doi/abs/10.1111/biom.12676</a></p>
<p>Xu, Y., Yu, M., Zhao, Y. Q., Li, Q., Wang, S., &amp; Shao, J. (2015),
 Regularized outcome weighted subgroup identification for differential treatment effects. Biometrics, 71(3), 645-653.
 doi: 10.1111/biom.12322 <a href='https://onlinelibrary.wiley.com/doi/full/10.1111/biom.12322'>https://onlinelibrary.wiley.com/doi/full/10.1111/biom.12322</a></p>
<p>Zhao, Y., Zeng, D., Rush, A. J., &amp; Kosorok, M. R. (2012),
  Estimating individualized treatment rules using outcome weighted learning.
  Journal of the American Statistical Association, 107(499), 1106-1118. doi: 10.1080/01621459.2012.695674</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='validate.subgroup.html'>validate.subgroup</a></code> for function which creates validation results for subgroup
identification models, <code><a href='predict.subgroup_fitted.html'>predict.subgroup_fitted</a></code> for a prediction function for fitted models
from <code>fit.subgroup</code>, <code><a href='plot.subgroup_fitted.html'>plot.subgroup_fitted</a></code> for a function which plots
results from fitted models, and <code><a href='print.subgroup_fitted.html'>print.subgroup_fitted</a></code>
for arguments for printing options for <code>fit.subgroup()</code>.
from <code>fit.subgroup</code>.</p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://jaredhuling.org/personalized/'>personalized</a></span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>123</span><span class='op'>)</span>
<span class='va'>n.obs</span>  <span class='op'>&lt;-</span> <span class='fl'>500</span>
<span class='va'>n.vars</span> <span class='op'>&lt;-</span> <span class='fl'>15</span>
<span class='va'>x</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>n.obs</span> <span class='op'>*</span> <span class='va'>n.vars</span>, sd <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span>, <span class='va'>n.obs</span>, <span class='va'>n.vars</span><span class='op'>)</span>


<span class='co'># simulate non-randomized treatment</span>
<span class='va'>xbetat</span>   <span class='op'>&lt;-</span> <span class='fl'>0.5</span> <span class='op'>+</span> <span class='fl'>0.5</span> <span class='op'>*</span> <span class='va'>x</span><span class='op'>[</span>,<span class='fl'>7</span><span class='op'>]</span> <span class='op'>-</span> <span class='fl'>0.5</span> <span class='op'>*</span> <span class='va'>x</span><span class='op'>[</span>,<span class='fl'>9</span><span class='op'>]</span>
<span class='va'>trt.prob</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>xbetat</span><span class='op'>)</span> <span class='op'>/</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>xbetat</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>trt01</span>    <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Binomial.html'>rbinom</a></span><span class='op'>(</span><span class='va'>n.obs</span>, <span class='fl'>1</span>, prob <span class='op'>=</span> <span class='va'>trt.prob</span><span class='op'>)</span>

<span class='va'>trt</span>      <span class='op'>&lt;-</span> <span class='fl'>2</span> <span class='op'>*</span> <span class='va'>trt01</span> <span class='op'>-</span> <span class='fl'>1</span>

<span class='co'># simulate response</span>
<span class='co'># delta below drives treatment effect heterogeneity</span>
<span class='va'>delta</span> <span class='op'>&lt;-</span> <span class='fl'>2</span> <span class='op'>*</span> <span class='op'>(</span><span class='fl'>0.5</span> <span class='op'>+</span> <span class='va'>x</span><span class='op'>[</span>,<span class='fl'>2</span><span class='op'>]</span> <span class='op'>-</span> <span class='va'>x</span><span class='op'>[</span>,<span class='fl'>3</span><span class='op'>]</span> <span class='op'>-</span> <span class='va'>x</span><span class='op'>[</span>,<span class='fl'>11</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>x</span><span class='op'>[</span>,<span class='fl'>1</span><span class='op'>]</span> <span class='op'>*</span> <span class='va'>x</span><span class='op'>[</span>,<span class='fl'>12</span><span class='op'>]</span> <span class='op'>)</span>
<span class='va'>xbeta</span> <span class='op'>&lt;-</span> <span class='va'>x</span><span class='op'>[</span>,<span class='fl'>1</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>x</span><span class='op'>[</span>,<span class='fl'>11</span><span class='op'>]</span> <span class='op'>-</span> <span class='fl'>2</span> <span class='op'>*</span> <span class='va'>x</span><span class='op'>[</span>,<span class='fl'>12</span><span class='op'>]</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>+</span> <span class='va'>x</span><span class='op'>[</span>,<span class='fl'>13</span><span class='op'>]</span> <span class='op'>+</span> <span class='fl'>0.5</span> <span class='op'>*</span> <span class='va'>x</span><span class='op'>[</span>,<span class='fl'>15</span><span class='op'>]</span> <span class='op'>^</span> <span class='fl'>2</span>
<span class='va'>xbeta</span> <span class='op'>&lt;-</span> <span class='va'>xbeta</span> <span class='op'>+</span> <span class='va'>delta</span> <span class='op'>*</span> <span class='va'>trt</span>

<span class='co'># continuous outcomes</span>
<span class='va'>y</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/drop.html'>drop</a></span><span class='op'>(</span><span class='va'>xbeta</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>n.obs</span>, sd <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>

<span class='co'># binary outcomes</span>
<span class='va'>y.binary</span> <span class='op'>&lt;-</span> <span class='fl'>1</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>xbeta</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>n.obs</span>, sd <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>&gt;</span> <span class='fl'>0</span> <span class='op'>)</span>

<span class='co'># count outcomes</span>
<span class='va'>y.count</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>xbeta</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>n.obs</span>, sd <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># time-to-event outcomes</span>
<span class='va'>surv.time</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>20</span> <span class='op'>-</span> <span class='va'>xbeta</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>n.obs</span>, sd <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>cens.time</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>n.obs</span>, sd <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>y.time.to.event</span>  <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>pmin</a></span><span class='op'>(</span><span class='va'>surv.time</span>, <span class='va'>cens.time</span><span class='op'>)</span>
<span class='va'>status</span>           <span class='op'>&lt;-</span> <span class='fl'>1</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>surv.time</span> <span class='op'>&lt;=</span> <span class='va'>cens.time</span><span class='op'>)</span>

<span class='co'># create function for fitting propensity score model</span>
<span class='va'>prop.func</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>trt</span><span class='op'>)</span>
<span class='op'>{</span>
    <span class='co'># fit propensity score model</span>
    <span class='va'>propens.model</span> <span class='op'>&lt;-</span> <span class='fu'>cv.glmnet</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>trt</span>,
                               x <span class='op'>=</span> <span class='va'>x</span>, family <span class='op'>=</span> <span class='st'>"binomial"</span><span class='op'>)</span>
    <span class='va'>pi.x</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>propens.model</span>, s <span class='op'>=</span> <span class='st'>"lambda.min"</span>,
                    newx <span class='op'>=</span> <span class='va'>x</span>, type <span class='op'>=</span> <span class='st'>"response"</span><span class='op'>)</span><span class='op'>[</span>,<span class='fl'>1</span><span class='op'>]</span>
    <span class='va'>pi.x</span>
<span class='op'>}</span>


<span class='co'>####################  Continuous outcomes ################################</span>


<span class='va'>subgrp.model</span> <span class='op'>&lt;-</span> <span class='fu'>fit.subgroup</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span>,
                           trt <span class='op'>=</span> <span class='va'>trt01</span>,
                           propensity.func <span class='op'>=</span> <span class='va'>prop.func</span>,
                           loss   <span class='op'>=</span> <span class='st'>"sq_loss_lasso"</span>,
                           nfolds <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span>              <span class='co'># option for cv.glmnet</span>

<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>subgrp.model</span><span class='op'>)</span>
</div><div class='output co'>#&gt; family:    gaussian 
#&gt; loss:      sq_loss_lasso 
#&gt; method:    weighting 
#&gt; cutpoint:  0 
#&gt; propensity 
#&gt; function:  propensity.func 
#&gt; 
#&gt; benefit score: f(x), 
#&gt; Trt recom = 1*I(f(x)&gt;c)+0*I(f(x)&lt;=c) where c is 'cutpoint'
#&gt; 
#&gt; Average Outcomes:
#&gt;                 Recommended 0      Recommended 1
#&gt; Received 0   -5.4606 (n = 81) -27.2778 (n = 120)
#&gt; Received 1 -26.8929 (n = 124)  -1.6271 (n = 175)
#&gt; 
#&gt; Treatment effects conditional on subgroups:
#&gt; Est of E[Y|T=0,Recom=0]-E[Y|T=/=0,Recom=0] 
#&gt;                          21.4323 (n = 205) 
#&gt; Est of E[Y|T=1,Recom=1]-E[Y|T=/=1,Recom=1] 
#&gt;                          25.6507 (n = 295) 
#&gt; 
#&gt; NOTE: The above average outcomes are biased estimates of
#&gt;       the expected outcomes conditional on subgroups. 
#&gt;       Use 'validate.subgroup()' to obtain unbiased estimates.
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Benefit score quantiles (f(X) for 1 vs 0): 
#&gt;      0%     25%     50%     75%    100% 
#&gt; -32.002  -4.996   2.423   9.251  29.137 
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Summary of individual treatment effects: 
#&gt; E[Y|T=1, X] - E[Y|T=0, X]
#&gt; 
#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#&gt; -64.004  -9.993   4.846   4.793  18.502  58.274 
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; 10 out of 15 interactions selected in total by the lasso (cross validation criterion).
#&gt; 
#&gt; The first estimate is the treatment main effect, which is always selected. 
#&gt; Any other variables selected represent treatment-covariate interactions.
#&gt; 
#&gt;            Trt1     V2      V3      V5   V6      V7     V8    V10     V11
#&gt; Estimate 2.6463 2.2645 -2.1415 -0.1068 0.43 -0.0028 0.5195 0.5581 -0.8164
#&gt;             V13    V15
#&gt; Estimate 1.3847 0.5343</div><div class='input'>
<span class='co'># estimates of the individual-specific</span>
<span class='co'># treatment effect estimates:</span>
<span class='va'>subgrp.model</span><span class='op'>$</span><span class='va'>individual.trt.effects</span>
</div><div class='output co'>#&gt; Summary of individual treatment effects: 
#&gt; E[Y|T=1, X] - E[Y|T=0, X]
#&gt; 
#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#&gt; -64.004  -9.993   4.846   4.793  18.502  58.274 </div><div class='input'>
<span class='co'># fit lasso + gam model with REML option for gam</span>

<span class='co'># \donttest{</span>
<span class='va'>subgrp.modelg</span> <span class='op'>&lt;-</span> <span class='fu'>fit.subgroup</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span>,
                            trt <span class='op'>=</span> <span class='va'>trt01</span>,
                            propensity.func <span class='op'>=</span> <span class='va'>prop.func</span>,
                            loss   <span class='op'>=</span> <span class='st'>"sq_loss_lasso_gam"</span>,
                            method.gam <span class='op'>=</span> <span class='st'>"REML"</span>,     <span class='co'># option for gam</span>
                            nfolds <span class='op'>=</span> <span class='fl'>5</span><span class='op'>)</span>              <span class='co'># option for cv.glmnet</span>

<span class='va'>subgrp.modelg</span>
</div><div class='output co'>#&gt; family:    gaussian 
#&gt; loss:      sq_loss_lasso_gam 
#&gt; method:    weighting 
#&gt; cutpoint:  0 
#&gt; propensity 
#&gt; function:  propensity.func 
#&gt; 
#&gt; benefit score: f(x), 
#&gt; Trt recom = 1*I(f(x)&gt;c)+0*I(f(x)&lt;=c) where c is 'cutpoint'
#&gt; 
#&gt; Average Outcomes:
#&gt;                 Recommended 0      Recommended 1
#&gt; Received 0   -13.255 (n = 83) -22.8448 (n = 118)
#&gt; Received 1 -23.1821 (n = 127)  -4.8953 (n = 172)
#&gt; 
#&gt; Treatment effects conditional on subgroups:
#&gt; Est of E[Y|T=0,Recom=0]-E[Y|T=/=0,Recom=0] 
#&gt;                           9.9271 (n = 210) 
#&gt; Est of E[Y|T=1,Recom=1]-E[Y|T=/=1,Recom=1] 
#&gt;                          17.9494 (n = 290) 
#&gt; 
#&gt; NOTE: The above average outcomes are biased estimates of
#&gt;       the expected outcomes conditional on subgroups. 
#&gt;       Use 'validate.subgroup()' to obtain unbiased estimates.
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Benefit score quantiles (f(X) for 1 vs 0): 
#&gt;      0%     25%     50%     75%    100% 
#&gt; -67.423  -4.499   1.785   8.953  38.711 
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Summary of individual treatment effects: 
#&gt; E[Y|T=1, X] - E[Y|T=0, X]
#&gt; 
#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
#&gt; -134.845   -8.997    3.570    3.647   17.906   77.422 </div><div class='input'><span class='co'># }</span>

<span class='co'>####################  Using an augmentation function #####################</span>
<span class='co'>## augmentation funcions involve modeling the conditional mean E[Y|T, X]</span>
<span class='co'>## and returning predictions that are averaged over the treatment values</span>
<span class='co'>## return &lt;- 1/2 * (hat{E}[Y|T=1, X] + hat{E}[Y|T=-1, X])</span>
<span class='co'>##########################################################################</span>

<span class='va'>augment.func</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span>, <span class='va'>trt</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>data</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span>, <span class='va'>trt</span><span class='op'>)</span>
    <span class='va'>xm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/model.matrix.html'>model.matrix</a></span><span class='op'>(</span><span class='va'>y</span><span class='op'>~</span><span class='va'>trt</span><span class='op'>*</span><span class='va'>x</span><span class='op'>-</span><span class='fl'>1</span>, data <span class='op'>=</span> <span class='va'>data</span><span class='op'>)</span>

    <span class='va'>lmod</span> <span class='op'>&lt;-</span> <span class='fu'>cv.glmnet</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>y</span>, x <span class='op'>=</span> <span class='va'>xm</span><span class='op'>)</span>
    <span class='co'>## get predictions when trt = 1</span>
    <span class='va'>data</span><span class='op'>$</span><span class='va'>trt</span> <span class='op'>&lt;-</span> <span class='fl'>1</span>
    <span class='va'>xm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/model.matrix.html'>model.matrix</a></span><span class='op'>(</span><span class='va'>y</span><span class='op'>~</span><span class='va'>trt</span><span class='op'>*</span><span class='va'>x</span><span class='op'>-</span><span class='fl'>1</span>, data <span class='op'>=</span> <span class='va'>data</span><span class='op'>)</span>
    <span class='va'>preds_1</span>  <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>lmod</span>, <span class='va'>xm</span>, s <span class='op'>=</span> <span class='st'>"lambda.min"</span><span class='op'>)</span>

    <span class='co'>## get predictions when trt = -1</span>
    <span class='va'>data</span><span class='op'>$</span><span class='va'>trt</span> <span class='op'>&lt;-</span> <span class='op'>-</span><span class='fl'>1</span>
    <span class='va'>xm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/model.matrix.html'>model.matrix</a></span><span class='op'>(</span><span class='va'>y</span><span class='op'>~</span><span class='va'>trt</span><span class='op'>*</span><span class='va'>x</span><span class='op'>-</span><span class='fl'>1</span>, data <span class='op'>=</span> <span class='va'>data</span><span class='op'>)</span>
    <span class='va'>preds_n1</span>  <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>lmod</span>, <span class='va'>xm</span>, s <span class='op'>=</span> <span class='st'>"lambda.min"</span><span class='op'>)</span>

    <span class='co'>## return predictions averaged over trt</span>
    <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='fl'>0.5</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>preds_1</span> <span class='op'>+</span> <span class='va'>preds_n1</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='co'># \donttest{</span>
<span class='va'>subgrp.model.aug</span> <span class='op'>&lt;-</span> <span class='fu'>fit.subgroup</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span>,
                           trt <span class='op'>=</span> <span class='va'>trt01</span>,
                           propensity.func <span class='op'>=</span> <span class='va'>prop.func</span>,
                           augment.func    <span class='op'>=</span> <span class='va'>augment.func</span>,
                           loss   <span class='op'>=</span> <span class='st'>"sq_loss_lasso"</span>,
                           nfolds <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span>              <span class='co'># option for cv.glmnet</span>

<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>subgrp.model.aug</span><span class='op'>)</span>
</div><div class='output co'>#&gt; family:    gaussian 
#&gt; loss:      sq_loss_lasso 
#&gt; method:    weighting 
#&gt; cutpoint:  0 
#&gt; augmentation 
#&gt; function: augment.func 
#&gt; propensity 
#&gt; function:  propensity.func 
#&gt; 
#&gt; benefit score: f(x), 
#&gt; Trt recom = 1*I(f(x)&gt;c)+0*I(f(x)&lt;=c) where c is 'cutpoint'
#&gt; 
#&gt; Average Outcomes:
#&gt;                Recommended 0      Recommended 1
#&gt; Received 0  -8.2593 (n = 83) -23.8274 (n = 118)
#&gt; Received 1 -26.798 (n = 117)  -2.4579 (n = 182)
#&gt; 
#&gt; Treatment effects conditional on subgroups:
#&gt; Est of E[Y|T=0,Recom=0]-E[Y|T=/=0,Recom=0] 
#&gt;                          18.5387 (n = 200) 
#&gt; Est of E[Y|T=1,Recom=1]-E[Y|T=/=1,Recom=1] 
#&gt;                          21.3695 (n = 300) 
#&gt; 
#&gt; NOTE: The above average outcomes are biased estimates of
#&gt;       the expected outcomes conditional on subgroups. 
#&gt;       Use 'validate.subgroup()' to obtain unbiased estimates.
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Benefit score quantiles (f(X) for 1 vs 0): 
#&gt;      0%     25%     50%     75%    100% 
#&gt; -33.022  -5.714   2.433  10.558  37.633 
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Summary of individual treatment effects: 
#&gt; E[Y|T=1, X] - E[Y|T=0, X]
#&gt; 
#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#&gt; -66.045 -11.427   4.865   5.851  21.116  75.265 
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; 10 out of 15 interactions selected in total by the lasso (cross validation criterion).
#&gt; 
#&gt; The first estimate is the treatment main effect, which is always selected. 
#&gt; Any other variables selected represent treatment-covariate interactions.
#&gt; 
#&gt;           Trt1     V2      V3      V5     V6     V8      V9    V10     V11
#&gt; Estimate 3.061 2.1429 -2.4738 -0.0522 0.6815 0.9514 -0.3491 0.6354 -1.0507
#&gt;             V13    V15
#&gt; Estimate 1.2763 1.0572</div><div class='input'><span class='co'># }</span>

<span class='co'>####################  Binary outcomes ####################################</span>

<span class='co'># use logistic loss for binary outcomes</span>
<span class='va'>subgrp.model.bin</span> <span class='op'>&lt;-</span> <span class='fu'>fit.subgroup</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y.binary</span>,
                           trt <span class='op'>=</span> <span class='va'>trt01</span>,
                           propensity.func <span class='op'>=</span> <span class='va'>prop.func</span>,
                           loss   <span class='op'>=</span> <span class='st'>"logistic_loss_lasso"</span>,
                           type.measure <span class='op'>=</span> <span class='st'>"auc"</span>,    <span class='co'># option for cv.glmnet</span>
                           nfolds <span class='op'>=</span> <span class='fl'>5</span><span class='op'>)</span>              <span class='co'># option for cv.glmnet</span>

<span class='va'>subgrp.model.bin</span>
</div><div class='output co'>#&gt; family:    binomial 
#&gt; loss:      logistic_loss_lasso 
#&gt; method:    weighting 
#&gt; cutpoint:  0 
#&gt; propensity 
#&gt; function:  propensity.func 
#&gt; 
#&gt; benefit score: f(x), 
#&gt; Trt recom = 1*I(f(x)&gt;c)+0*I(f(x)&lt;=c) where c is 'cutpoint'
#&gt; 
#&gt; Average Outcomes:
#&gt;               Recommended 0    Recommended 1
#&gt; Received 0  0.5544 (n = 84) 0.1651 (n = 117)
#&gt; Received 1 0.1801 (n = 116)  0.526 (n = 183)
#&gt; 
#&gt; Treatment effects conditional on subgroups:
#&gt; Est of E[Y|T=0,Recom=0]-E[Y|T=/=0,Recom=0] 
#&gt;                           0.3743 (n = 200) 
#&gt; Est of E[Y|T=1,Recom=1]-E[Y|T=/=1,Recom=1] 
#&gt;                            0.361 (n = 300) 
#&gt; 
#&gt; NOTE: The above average outcomes are biased estimates of
#&gt;       the expected outcomes conditional on subgroups. 
#&gt;       Use 'validate.subgroup()' to obtain unbiased estimates.
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Benefit score quantiles (f(X) for 1 vs 0): 
#&gt;      0%     25%     50%     75%    100% 
#&gt; -1.4737 -0.1959  0.1478  0.5169  1.6003 
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Summary of individual treatment effects: 
#&gt; E[Y|T=1, X] - E[Y|T=0, X]
#&gt; 
#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
#&gt; -0.62723 -0.09763  0.07376  0.07294  0.25283  0.66411 </div><div class='input'>

<span class='co'>####################  Count outcomes #####################################</span>

<span class='co'># use poisson loss for count/poisson outcomes</span>
<span class='va'>subgrp.model.poisson</span> <span class='op'>&lt;-</span> <span class='fu'>fit.subgroup</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y.count</span>,
                           trt <span class='op'>=</span> <span class='va'>trt01</span>,
                           propensity.func <span class='op'>=</span> <span class='va'>prop.func</span>,
                           loss   <span class='op'>=</span> <span class='st'>"poisson_loss_lasso"</span>,
                           type.measure <span class='op'>=</span> <span class='st'>"mse"</span>,    <span class='co'># option for cv.glmnet</span>
                           nfolds <span class='op'>=</span> <span class='fl'>5</span><span class='op'>)</span>              <span class='co'># option for cv.glmnet</span>

<span class='va'>subgrp.model.poisson</span>
</div><div class='output co'>#&gt; family:    poisson 
#&gt; loss:      poisson_loss_lasso 
#&gt; method:    weighting 
#&gt; cutpoint:  0 
#&gt; propensity 
#&gt; function:  propensity.func 
#&gt; 
#&gt; benefit score: f(x), 
#&gt; Trt recom = 1*I(f(x)&gt;c)+0*I(f(x)&lt;=c) where c is 'cutpoint'
#&gt; 
#&gt; Average Outcomes:
#&gt;                Recommended 0    Recommended 1
#&gt; Received 0 27.5574 (n = 150) 18.1547 (n = 51)
#&gt; Received 1 21.3632 (n = 217) 24.3561 (n = 82)
#&gt; 
#&gt; Treatment effects conditional on subgroups:
#&gt; Est of E[Y|T=0,Recom=0]-E[Y|T=/=0,Recom=0] 
#&gt;                           6.1942 (n = 367) 
#&gt; Est of E[Y|T=1,Recom=1]-E[Y|T=/=1,Recom=1] 
#&gt;                           6.2015 (n = 133) 
#&gt; 
#&gt; NOTE: The above average outcomes are biased estimates of
#&gt;       the expected outcomes conditional on subgroups. 
#&gt;       Use 'validate.subgroup()' to obtain unbiased estimates.
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Benefit score quantiles (f(X) for 1 vs 0): 
#&gt;       0%      25%      50%      75%     100% 
#&gt; -2.56965 -1.00854 -0.41805  0.03301  1.98044 
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Summary of individual treatment effects: 
#&gt; E[Y|T=1, X] - E[Y|T=0, X]
#&gt; 
#&gt;      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
#&gt; -12.98475  -2.37684  -0.86066  -1.22890   0.06604   7.10794 </div><div class='input'>

<span class='co'>####################  Time-to-event outcomes #############################</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/therneau/survival'>survival</a></span><span class='op'>)</span>
<span class='co'># \donttest{</span>
<span class='va'>subgrp.model.cox</span> <span class='op'>&lt;-</span> <span class='fu'>fit.subgroup</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/survival/man/Surv.html'>Surv</a></span><span class='op'>(</span><span class='va'>y.time.to.event</span>, <span class='va'>status</span><span class='op'>)</span>,
                           trt <span class='op'>=</span> <span class='va'>trt01</span>,
                           propensity.func <span class='op'>=</span> <span class='va'>prop.func</span>,
                           loss   <span class='op'>=</span> <span class='st'>"cox_loss_lasso"</span>,
                           nfolds <span class='op'>=</span> <span class='fl'>5</span><span class='op'>)</span>              <span class='co'># option for cv.glmnet</span>

<span class='va'>subgrp.model.cox</span>
</div><div class='output co'>#&gt; family:    cox 
#&gt; loss:      cox_loss_lasso 
#&gt; method:    weighting 
#&gt; cutpoint:  0 
#&gt; propensity 
#&gt; function:  propensity.func 
#&gt; 
#&gt; benefit score: f(x), 
#&gt; Trt recom = 1*I(f(x)&gt;c)+0*I(f(x)&lt;=c) where c is 'cutpoint'
#&gt; 
#&gt; Average Outcomes:
#&gt;                 Recommended 0     Recommended 1
#&gt; Received 0  175.712 (n = 140)   8.4705 (n = 61)
#&gt; Received 1 175.6092 (n = 205) 310.8642 (n = 94)
#&gt; 
#&gt; Treatment effects conditional on subgroups:
#&gt; Est of E[Y|T=0,Recom=0]-E[Y|T=/=0,Recom=0] 
#&gt;                           0.1028 (n = 345) 
#&gt; Est of E[Y|T=1,Recom=1]-E[Y|T=/=1,Recom=1] 
#&gt;                         302.3937 (n = 155) 
#&gt; 
#&gt; NOTE: The above average outcomes are biased estimates of
#&gt;       the expected outcomes conditional on subgroups. 
#&gt;       Use 'validate.subgroup()' to obtain unbiased estimates.
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Benefit score quantiles (f(X) for 1 vs 0): 
#&gt;       0%      25%      50%      75%     100% 
#&gt; -0.88151 -0.35174 -0.15110  0.06344  0.88137 
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Summary of individual treatment effects: 
#&gt; E[Y|T=1, X] / E[Y|T=0, X]
#&gt; 
#&gt; Note: for survival outcomes, the above ratio is 
#&gt; E[g(Y)|T=1, X] / E[g(Y)|T=0, X], 
#&gt; where g() is a monotone increasing function of Y, 
#&gt; the survival time
#&gt; 
#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#&gt;  0.4142  0.9385  1.1631  1.2159  1.4215  2.4145 </div><div class='input'><span class='co'># }</span>


<span class='co'>####################  Using custom loss functions ########################</span>

<span class='co'>## Use custom loss function for binary outcomes</span>

<span class='va'>fit.custom.loss.bin</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span>, <span class='va'>weights</span>, <span class='va'>offset</span>, <span class='va'>...</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>df</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>y</span>, <span class='va'>x</span><span class='op'>)</span>

    <span class='co'># minimize logistic loss with NO lasso penalty</span>
    <span class='co'># with allowance for efficiency augmentation</span>
    <span class='va'>glmf</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/glm.html'>glm</a></span><span class='op'>(</span><span class='va'>y</span> <span class='op'>~</span> <span class='va'>x</span> <span class='op'>-</span> <span class='fl'>1</span>, weights <span class='op'>=</span> <span class='va'>weights</span>,
                offset <span class='op'>=</span> <span class='va'>offset</span>, <span class='co'># offset term allows for efficiency augmentation</span>
                family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>binomial</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='va'>...</span><span class='op'>)</span>

    <span class='co'># save coefficients</span>
    <span class='va'>cfs</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/coef.html'>coef</a></span><span class='op'>(</span><span class='va'>glmf</span><span class='op'>)</span>

    <span class='co'># create prediction function.</span>
    <span class='va'>prd</span> <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>type</span> <span class='op'>=</span> <span class='st'>"response"</span><span class='op'>)</span> <span class='op'>{</span>
         <span class='va'>dfte</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>x</span><span class='op'>)</span>
         <span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span><span class='op'>(</span><span class='va'>dfte</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>cfs</span><span class='op'>)</span>
         <span class='co'>## predictions must be returned on the scale</span>
         <span class='co'>## of the linear predictor</span>
         <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>glmf</span>, <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span><span class='va'>dfte</span><span class='op'>)</span>, type <span class='op'>=</span> <span class='st'>"link"</span><span class='op'>)</span>
    <span class='op'>}</span>
    <span class='co'># return lost of required components</span>
    <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>predict <span class='op'>=</span> <span class='va'>prd</span>, model <span class='op'>=</span> <span class='va'>glmf</span>, coefficients <span class='op'>=</span> <span class='va'>cfs</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='co'># \donttest{</span>
<span class='va'>subgrp.model.bin.cust</span> <span class='op'>&lt;-</span> <span class='fu'>fit.subgroup</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y.binary</span>,
                                 trt <span class='op'>=</span> <span class='va'>trt01</span>,
                                 propensity.func <span class='op'>=</span> <span class='va'>prop.func</span>,
                                 fit.custom.loss <span class='op'>=</span> <span class='va'>fit.custom.loss.bin</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='warning'>Warning: non-integer #successes in a binomial glm!</span></div><div class='input'>
<span class='va'>subgrp.model.bin.cust</span>
</div><div class='output co'>#&gt; family:    gaussian 
#&gt; loss:      custom 
#&gt; method:    weighting 
#&gt; cutpoint:  0 
#&gt; propensity 
#&gt; function:  propensity.func 
#&gt; 
#&gt; benefit score: f(x), 
#&gt; Trt recom = 1*I(f(x)&gt;c)+0*I(f(x)&lt;=c) where c is 'cutpoint'
#&gt; 
#&gt; Average Outcomes:
#&gt;               Recommended 0    Recommended 1
#&gt; Received 0 0.1761 (n = 109)  0.4712 (n = 92)
#&gt; Received 1 0.1818 (n = 149) 0.5965 (n = 150)
#&gt; 
#&gt; Treatment effects conditional on subgroups:
#&gt; Est of E[Y|T=0,Recom=0]-E[Y|T=/=0,Recom=0] 
#&gt;                          -0.0057 (n = 258) 
#&gt; Est of E[Y|T=1,Recom=1]-E[Y|T=/=1,Recom=1] 
#&gt;                           0.1254 (n = 242) 
#&gt; 
#&gt; NOTE: The above average outcomes are biased estimates of
#&gt;       the expected outcomes conditional on subgroups. 
#&gt;       Use 'validate.subgroup()' to obtain unbiased estimates.
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Benefit score quantiles (f(X) for 1 vs 0): 
#&gt;       0%      25%      50%      75%     100% 
#&gt; -3.32689 -0.83519 -0.03229  0.72308  3.06675 
#&gt; 
#&gt; ---------------------------------------------------
#&gt; </div><div class='input'><span class='co'># }</span>


<span class='co'>## try exponential loss for</span>
<span class='co'>## positive outcomes</span>

<span class='va'>fit.expo.loss</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span>, <span class='va'>weights</span>, <span class='va'>...</span><span class='op'>)</span>
<span class='op'>{</span>
    <span class='va'>expo.loss</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>beta</span>, <span class='va'>x</span>, <span class='va'>y</span>, <span class='va'>weights</span><span class='op'>)</span> <span class='op'>{</span>
        <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>weights</span> <span class='op'>*</span> <span class='va'>y</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/drop.html'>drop</a></span><span class='op'>(</span><span class='va'>x</span> <span class='op'>%*%</span> <span class='va'>beta</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
    <span class='op'>}</span>

    <span class='co'># use optim() to minimize loss function</span>
    <span class='va'>opt</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/optim.html'>optim</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>NCOL</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span><span class='op'>)</span>, fn <span class='op'>=</span> <span class='va'>expo.loss</span>, x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span>, weights <span class='op'>=</span> <span class='va'>weights</span><span class='op'>)</span>

    <span class='va'>coefs</span> <span class='op'>&lt;-</span> <span class='va'>opt</span><span class='op'>$</span><span class='va'>par</span>

    <span class='va'>pred</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>type</span> <span class='op'>=</span> <span class='st'>"response"</span><span class='op'>)</span> <span class='op'>{</span>
        <span class='fu'><a href='https://rdrr.io/r/base/crossprod.html'>tcrossprod</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>x</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='va'>coefs</span><span class='op'>)</span><span class='op'>)</span>
    <span class='op'>}</span>

    <span class='co'># return list of required components</span>
    <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>predict <span class='op'>=</span> <span class='va'>pred</span>, model <span class='op'>=</span> <span class='va'>opt</span>, coefficients <span class='op'>=</span> <span class='va'>coefs</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='co'># \donttest{</span>
<span class='co'># use exponential loss for positive outcomes</span>
<span class='va'>subgrp.model.expo</span> <span class='op'>&lt;-</span> <span class='fu'>fit.subgroup</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y.count</span>,
                                  trt <span class='op'>=</span> <span class='va'>trt01</span>,
                                  propensity.func <span class='op'>=</span> <span class='va'>prop.func</span>,
                                  fit.custom.loss <span class='op'>=</span> <span class='va'>fit.expo.loss</span><span class='op'>)</span>

<span class='va'>subgrp.model.expo</span>
</div><div class='output co'>#&gt; family:    gaussian 
#&gt; loss:      custom 
#&gt; method:    weighting 
#&gt; cutpoint:  0 
#&gt; propensity 
#&gt; function:  propensity.func 
#&gt; 
#&gt; benefit score: f(x), 
#&gt; Trt recom = 1*I(f(x)&gt;c)+0*I(f(x)&lt;=c) where c is 'cutpoint'
#&gt; 
#&gt; Average Outcomes:
#&gt;                Recommended 0     Recommended 1
#&gt; Received 0 29.6494 (n = 148)  15.4769 (n = 53)
#&gt; Received 1 15.0543 (n = 114) 27.9722 (n = 185)
#&gt; 
#&gt; Treatment effects conditional on subgroups:
#&gt; Est of E[Y|T=0,Recom=0]-E[Y|T=/=0,Recom=0] 
#&gt;                          14.5951 (n = 262) 
#&gt; Est of E[Y|T=1,Recom=1]-E[Y|T=/=1,Recom=1] 
#&gt;                          12.4953 (n = 238) 
#&gt; 
#&gt; NOTE: The above average outcomes are biased estimates of
#&gt;       the expected outcomes conditional on subgroups. 
#&gt;       Use 'validate.subgroup()' to obtain unbiased estimates.
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Benefit score quantiles (f(X) for 1 vs 0): 
#&gt;       0%      25%      50%      75%     100% 
#&gt; -1.05447 -0.30240 -0.03526  0.27545  1.44799 
#&gt; 
#&gt; ---------------------------------------------------
#&gt; </div><div class='input'><span class='co'># }</span>


</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Jared Huling.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


